changes from Simon and xingcw on dev.
